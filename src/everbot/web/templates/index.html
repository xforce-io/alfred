{% extends "base.html" %}

{% block content %}
<!-- é¡¶éƒ¨ Tab æ  -->
<div class="tabs">
  <div class="tab active" onclick="switchTab('chat')">ğŸ’¬ Chat</div>
  <div class="tab" onclick="switchTab('status')">ğŸ“Š Status</div>
  <div class="tab" onclick="switchTab('logs')">ğŸ“ Logs</div>
  <div class="tab" onclick="switchTab('settings')">âš™ï¸ Settings</div>
</div>

<!-- å†…å®¹åŒºåŸŸ -->
<div class="content">
  <!-- Chat é¢æ¿ï¼ˆé»˜è®¤ï¼‰ -->
  <div id="chat-panel" class="panel active">
    <div class="chat-header">
      <select id="agent-selector" class="agent-selector">
        <option value="">åŠ è½½ Agent åˆ—è¡¨...</option>
      </select>
      <select id="session-selector" class="agent-selector" title="ä¼šè¯">
        <option value="">åŠ è½½ä¼šè¯...</option>
      </select>
      <button id="new-chat-btn" type="button" class="new-chat-btn" onclick="newConversation(event)" title="æ–°å»ºå¯¹è¯">+
        æ–°å¯¹è¯</button>
      <button id="clear-history-btn" type="button" class="new-chat-btn" onclick="clearHistory()"
        title="æ¸…é™¤å½“å‰ä¼šè¯çš„èŠå¤©è®°å½•">æ¸…é™¤å†å²</button>
      <div class="chat-header-spacer"></div>
      <button id="trace-btn" type="button" class="trace-btn" onclick="openTraceModal()"
        title="æŸ¥çœ‹ Context Traceã€Timeline ä¸ Trajectory">ğŸ“Š Trace</button>
    </div>
    <div id="chat-messages" class="chat-messages">
      <div class="message assistant">
        <div class="message-bubble">
          ä½ å¥½ï¼æˆ‘æ˜¯ EverBotã€‚é€‰æ‹©ä¸€ä¸ª Agent å¼€å§‹å¯¹è¯å§ã€‚
        </div>
      </div>
    </div>
    <div id="chat-status-bar"
      style="padding: 4px 24px; font-size: 12px; color: #888; background: #fff; min-height: 20px;"></div>
    <button id="chat-latest" type="button" class="chat-latest-btn" onclick="scrollToLatest()" title="å›åˆ°æœ€æ–°">â†“</button>
    <div class="chat-input">
      <input id="chat-input" type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." />
      <button id="chat-send" type="button" onclick="sendMessage()">å‘é€</button>
      <button id="chat-stop" type="button" onclick="stopMessage()" style="display:none; background:#ff3b30;">åœæ­¢</button>
    </div>
  </div>

  <!-- Status é¢æ¿ -->
  <div id="status-panel" class="panel">
    <div class="status-card">
      <h3>å®ˆæŠ¤è¿›ç¨‹çŠ¶æ€</h3>
      <div id="daemon-status">åŠ è½½ä¸­...</div>
    </div>
    <div class="status-card">
      <h3>Agents</h3>
      <div id="agents-list">åŠ è½½ä¸­...</div>
    </div>
    <div class="status-card">
      <h3>æ“ä½œ</h3>
      <button class="btn" type="button" onclick="triggerHeartbeat()">æ‰‹åŠ¨è§¦å‘å¿ƒè·³</button>
    </div>
  </div>

  <!-- Logs é¢æ¿ -->
  <div id="logs-panel" class="panel">
    <div class="status-card">
      <h3>å¿ƒè·³äº‹ä»¶</h3>
      <div id="heartbeat-events" class="events-container"></div>
    </div>
  </div>

  <!-- Settings é¢æ¿ -->
  <div id="settings-panel" class="panel">
    <div class="status-card">
      <h3>Telegram Channel</h3>
      <form id="telegram-settings-form" onsubmit="event.preventDefault(); saveTelegramSettings();">
        <div class="settings-field">
          <label class="settings-label">
            <input type="checkbox" id="tg-enabled" />
            å¯ç”¨ Telegram Channel
          </label>
        </div>
        <div class="settings-field">
          <label class="settings-label">Bot Token</label>
          <input type="text" id="tg-bot-token" class="settings-input" readonly disabled placeholder="é€šè¿‡ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶è®¾ç½®" />
          <div class="settings-hint">Bot Token ä¸å¯é€šè¿‡ Web ä¿®æ”¹ï¼Œè¯·ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–ç¼–è¾‘ config.yaml</div>
        </div>
        <div class="settings-field">
          <label class="settings-label">Default Agent</label>
          <select id="tg-default-agent" class="settings-input"></select>
        </div>
        <div class="settings-field">
          <label class="settings-label">Allowed Chat IDs</label>
          <input type="text" id="tg-allowed-chat-ids" class="settings-input" placeholder="é€—å·åˆ†éš”ï¼Œå¦‚ 12345,67890" />
          <div class="settings-hint">å…è®¸ä½¿ç”¨ Bot çš„ Telegram Chat IDï¼Œé€—å·åˆ†éš”</div>
        </div>
        <div class="settings-actions">
          <button type="submit" class="btn">ä¿å­˜</button>
          <span id="tg-save-status" class="settings-status"></span>
        </div>
      </form>
    </div>
    <div class="status-card">
      <h3>Skills</h3>
      <div class="settings-hint" style="margin-bottom: 12px;">ç®¡ç†å·²å®‰è£…çš„æŠ€èƒ½ï¼Œåˆ‡æ¢å¯ç”¨/ç¦ç”¨çŠ¶æ€ã€‚ç¦ç”¨çš„æŠ€èƒ½ä¸ä¼šå‡ºç°åœ¨ Agent prompt ä¸­ã€‚å˜æ›´åœ¨æ–°å»ºå¯¹è¯åç”Ÿæ•ˆã€‚</div>
      <div id="skills-list" class="skills-list">åŠ è½½ä¸­...</div>
    </div>
    <div class="status-card">
      <h3>å±é™©æ“ä½œ</h3>
      <div class="settings-field">
        <div class="settings-hint" style="margin-bottom: 8px;">é‡ç½®å°†åˆ é™¤å½“å‰ Agent çš„æ‰€æœ‰ä¼šè¯ã€ä¸´æ—¶æ–‡ä»¶ä¸ç¼“å­˜ï¼Œä¸å¯æ¢å¤ã€‚</div>
        <button id="reset-env-btn" type="button" class="btn" style="background: #e74c3c; color: #fff;"
          onclick="resetEnvironment()">é‡ç½® Agent ç¯å¢ƒ</button>
      </div>
    </div>
  </div>
</div>

<div id="trace-modal-overlay" class="trace-modal-overlay" onclick="closeTraceModal(event)">
  <div class="trace-modal" onclick="event.stopPropagation()">
    <div class="trace-modal-header">
      <div class="trace-tabs">
        <button id="trace-tab-trace" class="trace-tab active" onclick="switchTraceTab('trace')">Context Trace</button>
        <button id="trace-tab-trajectory" class="trace-tab" onclick="switchTraceTab('trajectory')">Timeline</button>
        <button id="trace-tab-dolphin" class="trace-tab" onclick="switchTraceTab('dolphin')">Trajectory</button>
      </div>
      <div class="trace-modal-actions">
        <button class="trace-action-btn" type="button" onclick="downloadTraceJSON('trace')">ä¸‹è½½ Context Trace</button>
        <button class="trace-action-btn" type="button" onclick="downloadTraceJSON('trajectory')">ä¸‹è½½ Timeline</button>
        <button class="trace-action-btn" type="button" onclick="downloadTraceJSON('dolphin')">ä¸‹è½½ Trajectory</button>
        <button class="trace-close-btn" type="button" onclick="closeTraceModal()">å…³é—­</button>
      </div>
    </div>
    <div class="trace-modal-body">
      <div id="trace-content" class="trace-content active"></div>
      <div id="trajectory-content" class="trace-content"></div>
      <div id="dolphin-content" class="trace-content"></div>
    </div>
  </div>
</div>
{% endblock %}